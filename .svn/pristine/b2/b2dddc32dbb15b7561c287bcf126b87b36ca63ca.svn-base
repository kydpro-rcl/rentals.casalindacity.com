<?php
require_once('inc/session.php');
header('Content-type: application/vnd.ms-excel');
$an=$_GET['y']; $mes=$_GET['m'];
header("Content-Disposition: attachment; filename=bookings$mes$an.xls");
header("Pragma: no-cache");
header("Expires: 0");

if ($_SESSION['info']){

	require_once('init.php');

	   $db= new getQueries();
		$result=$db->booking_per_months($month=$_GET['m'], $year=$_GET['y']);

		if ($result){

			?>
			 <p>&nbsp;</p>
			 <hr/>
			 <p style="font-weight:bold;">Total found: <?=count($result);?> bookings</p>
			<table align="center" cellpadding="2" cellspacing="2">
			<tr>
												<td colspan="7" align="center" width="85%" class="blue_light"><!--<p>--><strong>REPORT OF BOOKINGS PER MONTHS </strong><!--</p>-->
												</td>
											</tr>
				    						<tr bgcolor="#a6cdf4">
					    						<td align="center" class="blue_dark"><strong>Villa</strong>
					    						</td>
					    						<td align="center" class="blue_dark"><strong>From</strong>
					    						</td>
					    						<td  align="center" class="blue_dark"><strong>To</strong>
					    						</td>
					    						<td align="center" class="blue_dark"><strong>Total</strong>
					    						</td>

					    						<td align="center" class="blue_dark"><strong>Ref.</strong>
					    						</td>
					    						<td  class="blue_dark" align="center"><strong>Status</strong>
					    						</td>
												<td  class="blue_dark" align="center"><strong>Client's Email</strong>
					    						</td>
				    						</tr>
			<? 
			$total_mes='';
			$total_mes_confirmed='';
			$total_mes_noconfirmed='';
			foreach ($result as $b){
			  if(($b['status']!=0)&&($b['status']!=5)&&($b['status']!=7)&&($b['status']!=19)&&($b['status']!=20)&&($b['status']!=21)&&($b['status']!=22)&&($b['status']!=23)&&($b['status']!=24)&&($b['status']!=25)){		
				$client=$db->showTable_restrinted($table='customers', $condition="id=".$b['client'], $order='id');
				?>
				<tr  bgcolor="#CCCCCC" onclick="reserva('reserva_details.php?id=<?=$b['busyid']?>','Details for Selection', 530, 800)" title="Click to see Reservation" onmouseover="this.style.backgroundColor='#87a2fa'; this.style.cursor='hand';this.style.cursor='pointer';" onmouseout="this.style.backgroundColor=''" >
				<td style="font-size:9px" ><? $villa=$db->villa($b['villa']); echo $villa[0]['no'];?></td>
					 <td  style="font-size:11px" ><?=formatear_fecha($b['start'])?></td><td style="font-size:11px"  ><?=formatear_fecha($b['end'])?></td>
					<td style="font-size:11px; text-align:right;"  > US$ <?=number_format($b['total'],2)?></td>

					<td  style="font-size:11px" ><?=$b['ref']?></td>
					<td  style="font-size:10px" ><?=booking_status($b['status']);?></td>
					<td  style="font-size:11px" ><?=$client[0]['email']?></td>
				</tr>
			 <? 
				 if(($b['status']!=0)&&($b['status']!=5)){		 
					$total_mes+=$b['total'];
					if(($b['status']!=3)){		 
						$total_mes_confirmed+=$b['total'];
					}else{
						$total_mes_noconfirmed+=$b['total'];
					}
				 }
			  } 
			 }?>
			 
			 <tr>
				<td colspan="3"><strong>Total USD per month</strong></td>
				<td colspan="2"><strong>Confirmed: <?=number_format($total_mes_confirmed,2)?></strong></td>
				<td colspan="2"><strong>No confirmed: <?=number_format($total_mes_noconfirmed,2)?></strong></td>
			 </tr>
			</table>
			<?

		}else{
			echo "<p>&nbsp;</p>";
			echo "<hr/>";
			echo "<p class='centro' style='font-weight:bold; font-size:16px;'>No bookings found for your search</p>";
		}

}else{
	 header('Location:login.php');
	die();
	 // echo ("<meta http-equiv=\"refresh\" content=\"0;url=../login.php\">");
  }
?>